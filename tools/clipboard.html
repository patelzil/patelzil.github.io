<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clipboard Manager - Zil Patel</title>
    <meta
      name="description"
      content="A local clipboard manager to store and manage copied text and images"
    />
    <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="/style.css" />
    <style>
      .clipboard-container {
        max-width: 900px;
        margin: 0 auto;
      }

      .tool-header {
        margin-bottom: 2rem;
      }

      .back-link {
        display: inline-block;
        color: var(--color-text-secondary);
        text-decoration: none;
        margin-bottom: 1rem;
        font-size: 0.9rem;
      }

      .back-link:hover {
        color: var(--color-accent);
      }

      .privacy-notice {
        background: var(--color-bg-secondary);
        border-left: 4px solid var(--color-accent);
        padding: 1rem;
        margin-bottom: 2rem;
        border-radius: 4px;
      }

      .privacy-notice p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--color-text-secondary);
      }

      .paste-area {
        margin-bottom: 2rem;
      }

      .paste-input {
        width: 100%;
        min-height: 120px;
        padding: 1rem;
        border: 2px dashed var(--color-border);
        border-radius: 8px;
        background: var(--color-bg-secondary);
        color: var(--color-text);
        font-family: inherit;
        font-size: 0.95rem;
        resize: vertical;
        transition: border-color 0.2s;
      }

      .paste-input:focus {
        outline: none;
        border-color: var(--color-accent);
        border-style: solid;
      }

      .paste-input::placeholder {
        color: #a9a9ac;
        opacity: 1;
      }

      .controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
      }

      .btn {
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 500;
        transition: all 0.2s;
      }

      .btn-paste {
        background: var(--color-accent);
        color: white;
      }

      .btn-paste:hover {
        opacity: 0.9;
      }

      .btn-clear {
        background: #dc3545;
        color: white;
      }

      .btn-clear:hover {
        background: #c82333;
      }

      .items-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .clipboard-item {
        background: var(--color-bg-secondary);
        border: 1px solid var(--color-border);
        border-radius: 8px;
        padding: 1rem;
        transition: box-shadow 0.2s;
      }

      .clipboard-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        gap: 1rem;
      }

      .item-timestamp {
        font-size: 0.85rem;
        color: var(--color-text-secondary);
      }

      .item-type {
        display: inline-block;
        padding: 0.2rem 0.6rem;
        background: var(--color-accent);
        color: white;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .item-actions {
        display: flex;
        gap: 0.5rem;
      }

      .btn-icon {
        background: none;
        border: 1px solid var(--color-border);
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        color: var(--color-text);
        transition: all 0.2s;
      }

      .btn-icon:hover {
        background: var(--color-bg);
        border-color: var(--color-accent);
      }

      .btn-delete:hover {
        background: #dc3545;
        color: white;
        border-color: #dc3545;
      }

      .item-content {
        margin-top: 0.75rem;
      }

      .text-content {
        background: var(--color-bg);
        padding: 1rem;
        border-radius: 4px;
        font-family: "SF Mono", Monaco, "Cascadia Code", monospace;
        font-size: 0.9rem;
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 300px;
        overflow-y: auto;
      }

      .text-content.collapsed {
        max-height: 100px;
        overflow: hidden;
        position: relative;
      }

      .text-content.collapsed::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 40px;
        background: linear-gradient(to bottom, transparent, var(--color-bg));
      }

      .expand-btn {
        margin-top: 0.5rem;
        background: none;
        border: none;
        color: var(--color-accent);
        cursor: pointer;
        font-size: 0.85rem;
        padding: 0;
        text-decoration: underline;
      }

      .expand-btn:hover {
        color: var(--color-link-hover);
      }

      .image-content {
        display: flex;
        justify-content: center;
        align-items: center;
        background: var(--color-bg);
        padding: 1rem;
        border-radius: 4px;
      }

      .image-content img {
        max-width: 100%;
        max-height: 400px;
        border-radius: 4px;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .image-content img:hover {
        transform: scale(1.02);
      }

      .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--color-text-secondary);
      }

      .empty-state svg {
        width: 64px;
        height: 64px;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: var(--color-accent);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s;
        z-index: 1000;
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      .tool-footer {
        margin-top: 4rem;
        padding-top: 2rem;
        border-top: 1px solid var(--color-border);
        text-align: center;
        color: var(--color-text-secondary);
        font-size: 0.9rem;
      }

      .tool-footer a {
        color: var(--color-accent);
        text-decoration: none;
      }

      .tool-footer a:hover {
        text-decoration: underline;
      }

      @media (max-width: 640px) {
        .controls {
          flex-direction: column;
          align-items: stretch;
        }

        .item-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .item-actions {
          width: 100%;
          justify-content: flex-end;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <div class="clipboard-container">
        <div class="tool-header">
          <a href="/tools" class="back-link">‚Üê Back to Tools</a>
          <h1>Clipboard Manager</h1>
        </div>

        <div class="privacy-notice">
          <p>
            ‚ö†Ô∏è All clipboard data is stored locally in your browser. This data
            is not encrypted and remains until you manually delete it. Do not
            store sensitive information like passwords or API keys.
          </p>
        </div>

        <div class="paste-area">
          <textarea
            id="paste-input"
            class="paste-input"
            placeholder="Desktop: Paste anywhere on the page. Mobile: Tap here and paste your text or images."
          ></textarea>
        </div>

        <div class="controls">
          <button class="btn btn-paste" id="paste-btn">
            üìã Paste from Clipboard
          </button>
          <button class="btn btn-clear" id="clear-all">Clear All</button>
        </div>

        <div class="items-container" id="items-container">
          <div class="empty-state">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
              />
            </svg>
            <p>No clipboard items yet. Paste something to get started!</p>
          </div>
        </div>

        <div class="tool-footer">
          <p>
            View source on
            <a
              href="https://github.com/patelzil/patelzil.github.io/blob/main/tools/clipboard.html"
              target="_blank"
              rel="noopener noreferrer"
              >GitHub</a
            >
          </p>
        </div>
      </div>
    </main>

    <div class="toast" id="toast"></div>

    <script>
      // IndexedDB Storage Layer
      const DB_NAME = "clipboard";
      const STORE_NAME = "items";
      let db;

      async function initDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, 1);

          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            db = request.result;
            resolve(db);
          };

          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
              const store = db.createObjectStore(STORE_NAME, { keyPath: "id" });
              store.createIndex("timestamp", "timestamp", { unique: false });
            }
          };
        });
      }

      async function saveItem(type, content) {
        const item = {
          id: Date.now(),
          type: type,
          content: content,
          timestamp: new Date().toISOString(),
          preview: type === "text" ? content.substring(0, 200) : null,
        };

        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORE_NAME], "readwrite");
          const store = transaction.objectStore(STORE_NAME);
          const request = store.add(item);

          request.onsuccess = () => resolve(item);
          request.onerror = () => reject(request.error);
        });
      }

      async function getAllItems() {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORE_NAME], "readonly");
          const store = transaction.objectStore(STORE_NAME);
          const request = store.getAll();

          request.onsuccess = () => {
            const items = request.result;
            items.sort((a, b) => b.id - a.id); // Sort newest first
            resolve(items);
          };
          request.onerror = () => reject(request.error);
        });
      }

      async function deleteItem(id) {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORE_NAME], "readwrite");
          const store = transaction.objectStore(STORE_NAME);
          const request = store.delete(id);

          request.onsuccess = () => resolve();
          request.onerror = () => reject(request.error);
        });
      }

      async function clearAll() {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORE_NAME], "readwrite");
          const store = transaction.objectStore(STORE_NAME);
          const request = store.clear();

          request.onsuccess = () => resolve();
          request.onerror = () => reject(request.error);
        });
      }

      // UI Functions
      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2000);
      }

      function formatTimestamp(isoString) {
        const date = new Date(isoString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return "Just now";
        if (diffMins < 60)
          return `${diffMins} minute${diffMins > 1 ? "s" : ""} ago`;
        if (diffHours < 24)
          return `${diffHours} hour${diffHours > 1 ? "s" : ""} ago`;
        if (diffDays < 7)
          return `${diffDays} day${diffDays > 1 ? "s" : ""} ago`;

        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year:
            date.getFullYear() !== now.getFullYear() ? "numeric" : undefined,
        });
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      async function renderItems() {
        const container = document.getElementById("items-container");
        const items = await getAllItems();

        if (items.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
              <p>No clipboard items yet. Paste something to get started!</p>
            </div>
          `;
          return;
        }

        container.innerHTML = items
          .map((item) => {
            const isLongText =
              item.type === "text" && item.content.length > 500;

            return `
            <div class="clipboard-item" data-id="${item.id}">
              <div class="item-header">
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                  <span class="item-type">${item.type}</span>
                  <span class="item-timestamp">${formatTimestamp(
                    item.timestamp
                  )}</span>
                </div>
                <div class="item-actions">
                  <button class="btn-icon btn-copy" data-id="${
                    item.id
                  }">üìã Copy</button>
                  <button class="btn-icon btn-delete" data-id="${
                    item.id
                  }">üóëÔ∏è Delete</button>
                </div>
              </div>
              <div class="item-content">
                ${
                  item.type === "text"
                    ? `<div class="text-content ${
                        isLongText ? "collapsed" : ""
                      }" data-id="text-${item.id}">${escapeHtml(
                        item.content
                      )}</div>
                     ${
                       isLongText
                         ? `<button class="expand-btn" data-id="text-${item.id}">Show more</button>`
                         : ""
                     }`
                    : `<div class="image-content" data-id="img-${item.id}">
                       <img src="" alt="Clipboard image" data-id="${item.id}">
                     </div>`
                }
              </div>
            </div>
          `;
          })
          .join("");

        // Load image blobs
        items.forEach((item) => {
          if (item.type === "image") {
            const img = container.querySelector(`img[data-id="${item.id}"]`);
            if (img && item.content instanceof Blob) {
              img.src = URL.createObjectURL(item.content);
            }
          }
        });

        attachEventListeners();
      }

      function attachEventListeners() {
        // Copy buttons
        document.querySelectorAll(".btn-copy").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const id = parseInt(e.target.dataset.id);
            const items = await getAllItems();
            const item = items.find((i) => i.id === id);
            if (!item) return;

            try {
              if (item.type === "text") {
                await navigator.clipboard.writeText(item.content);
                showToast("Copied to clipboard!");
              } else if (item.type === "image") {
                const clipboardItem = new ClipboardItem({
                  [item.content.type]: item.content,
                });
                await navigator.clipboard.write([clipboardItem]);
                showToast("Image copied to clipboard!");
              }
            } catch (err) {
              console.error("Copy failed:", err);
              showToast("Failed to copy");
            }
          });
        });

        // Delete buttons
        document.querySelectorAll(".btn-delete").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const id = parseInt(e.target.dataset.id);
            await deleteItem(id);
            await renderItems();
            showToast("Item deleted");
          });
        });

        // Expand/collapse long text
        document.querySelectorAll(".expand-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const textId = e.target.dataset.id;
            const textElement = document.querySelector(
              `.text-content[data-id="${textId}"]`
            );

            if (textElement.classList.contains("collapsed")) {
              textElement.classList.remove("collapsed");
              e.target.textContent = "Show less";
            } else {
              textElement.classList.add("collapsed");
              e.target.textContent = "Show more";
            }
          });
        });
      }

      document.addEventListener("paste", async (e) => {
        e.preventDefault();

        const items = e.clipboardData.items;
        let saved = false;

        // Check for images first
        for (let item of items) {
          if (item.type.startsWith("image/")) {
            const file = item.getAsFile();
            if (file) {
              await saveItem("image", file);
              saved = true;
              showToast("Image saved!");
              break;
            }
          }
        }

        // If no image, check for text
        if (!saved) {
          const text = e.clipboardData.getData("text/plain");
          if (text && text.trim()) {
            await saveItem("text", text);
            showToast("Text saved!");
          }
        }

        // Clear the input field if paste happened there
        const pasteInput = document.getElementById("paste-input");
        if (e.target === pasteInput) {
          pasteInput.value = "";
        }

        await renderItems();
      });

      // Manual Paste Button (for Android and accessibility)
      document
        .getElementById("paste-btn")
        .addEventListener("click", async () => {
          try {
            const clipboardItems = await navigator.clipboard.read();
            let saved = false;

            for (const clipboardItem of clipboardItems) {
              // Check for images first
              for (const type of clipboardItem.types) {
                if (type.startsWith("image/")) {
                  const blob = await clipboardItem.getType(type);
                  await saveItem("image", blob);
                  showToast("Image saved!");
                  saved = true;
                  break;
                }
              }
              if (saved) break;
            }

            // If no image, try text
            if (!saved) {
              const text = await navigator.clipboard.readText();
              if (text && text.trim()) {
                await saveItem("text", text);
                showToast("Text saved!");
              }
            }

            await renderItems();
          } catch (err) {
            console.error("Clipboard read failed:", err);
            showToast("Failed to read clipboard. Please paste manually.");
          }
        });

      // Clear All Handler
      document
        .getElementById("clear-all")
        .addEventListener("click", async () => {
          if (
            confirm(
              "Are you sure you want to delete all clipboard items? This cannot be undone."
            )
          ) {
            await clearAll();
            await renderItems();
            showToast("All items cleared");
          }
        });

      // Theme Initialization
      (function () {
        const body = document.body;
        const saved = localStorage.getItem("theme");
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;

        if (saved) {
          body.classList.add(saved);
        } else {
          body.classList.add(prefersDark ? "dark-mode" : "light-mode");
        }
      })();

      // Initialize
      (async function () {
        await initDB();
        await renderItems();
      })();
    </script>
  </body>
</html>
